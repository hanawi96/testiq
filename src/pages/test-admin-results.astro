---
// Test page để kiểm tra dữ liệu admin results
import { supabase } from '../backend/config/supabase';

let testResults = {
  userTestResults: null,
  sampleData: [],
  stats: null,
  errors: []
};

try {
  console.log('🔍 Testing admin results data...');
  
  // Query user_test_results để kiểm tra dữ liệu
  const { data: results, error } = await supabase
    .from('user_test_results')
    .select('*')
    .order('tested_at', { ascending: false })
    .limit(10);
  
  if (error) {
    testResults.errors.push(`Error: ${error.message}`);
  } else {
    testResults.userTestResults = results;
    testResults.sampleData = results?.slice(0, 5) || [];
    
    // Calculate basic stats
    if (results && results.length > 0) {
      const scores = results.map(r => r.score).filter(s => s != null);
      const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
      const maxScore = Math.max(...scores);
      const registeredCount = results.filter(r => r.user_id).length;
      const anonymousCount = results.filter(r => !r.user_id).length;
      
      testResults.stats = {
        total: results.length,
        avgScore,
        maxScore,
        registered: registeredCount,
        anonymous: anonymousCount
      };
    }
  }
  
} catch (err) {
  testResults.errors.push(`Exception: ${err.message}`);
}
---

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Test Admin Results Data</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold mb-8">🧪 Test Admin Results Data</h1>
    
    <!-- Errors -->
    {testResults.errors.length > 0 && (
      <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
        <h2 class="text-lg font-semibold text-red-800 mb-2">❌ Errors:</h2>
        <ul class="list-disc list-inside space-y-1">
          {testResults.errors.map(error => (
            <li class="text-red-700">{error}</li>
          ))}
        </ul>
      </div>
    )}

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      
      <!-- Stats Summary -->
      {testResults.stats && (
        <div class="bg-white rounded-lg shadow p-6">
          <h2 class="text-xl font-semibold mb-4">📊 Thống kê tổng quan</h2>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span>Tổng số test:</span>
              <span class="font-semibold">{testResults.stats.total}</span>
            </div>
            <div class="flex justify-between">
              <span>Điểm trung bình:</span>
              <span class="font-semibold">{testResults.stats.avgScore}</span>
            </div>
            <div class="flex justify-between">
              <span>Điểm cao nhất:</span>
              <span class="font-semibold">{testResults.stats.maxScore}</span>
            </div>
            <div class="flex justify-between">
              <span>User đã đăng ký:</span>
              <span class="font-semibold text-green-600">{testResults.stats.registered}</span>
            </div>
            <div class="flex justify-between">
              <span>User ẩn danh:</span>
              <span class="font-semibold text-orange-600">{testResults.stats.anonymous}</span>
            </div>
          </div>
        </div>
      )}

      <!-- Sample Data -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold mb-4">📋 Dữ liệu mẫu</h2>
        {testResults.sampleData.length > 0 ? (
          <div class="space-y-3 max-h-64 overflow-y-auto">
            {testResults.sampleData.map(result => (
              <div class="bg-gray-50 p-3 rounded text-sm">
                <div class="flex justify-between items-start">
                  <div>
                    <div><strong>Tên:</strong> {result.name || 'N/A'}</div>
                    <div><strong>Email:</strong> {result.email || 'N/A'}</div>
                    <div><strong>Điểm:</strong> {result.score}</div>
                  </div>
                  <div class="text-right">
                    <div class={`px-2 py-1 rounded text-xs ${result.user_id ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}`}>
                      {result.user_id ? 'Đã đăng ký' : 'Ẩn danh'}
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                      {new Date(result.tested_at).toLocaleDateString('vi-VN')}
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        ) : (
          <p class="text-gray-500">Không có dữ liệu</p>
        )}
      </div>

    </div>

    <!-- Data Structure -->
    {testResults.userTestResults && testResults.userTestResults.length > 0 && (
      <div class="mt-8 bg-white rounded-lg shadow p-6">
        <h2 class="text-xl font-semibold mb-4">🔧 Cấu trúc dữ liệu</h2>
        <div class="bg-gray-100 p-4 rounded overflow-x-auto">
          <p class="text-sm font-medium mb-2">Columns available:</p>
          <div class="flex flex-wrap gap-2">
            {Object.keys(testResults.userTestResults[0]).map(key => (
              <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">{key}</span>
            ))}
          </div>
        </div>
        
        <details class="mt-4">
          <summary class="cursor-pointer font-medium">Sample Record (JSON)</summary>
          <pre class="mt-2 bg-gray-100 p-3 rounded text-sm overflow-auto">{JSON.stringify(testResults.userTestResults[0], null, 2)}</pre>
        </details>
      </div>
    )}

    <!-- Instructions -->
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
      <h2 class="text-xl font-semibold text-blue-800 mb-4">📋 Kiểm tra</h2>
      <div class="space-y-2 text-blue-700">
        <p><strong>Mục đích:</strong> Xác minh dữ liệu cho trang admin results</p>
        <ul class="list-disc list-inside ml-4 space-y-1">
          <li>Kiểm tra bảng <code>user_test_results</code> có dữ liệu</li>
          <li>Xác minh cấu trúc columns phù hợp với ResultsService</li>
          <li>Đảm bảo có cả registered và anonymous users</li>
          <li>Kiểm tra các trường cần thiết: score, tested_at, name, email, etc.</li>
        </ul>
      </div>
    </div>

    <div class="mt-6 text-center space-x-4">
      <a href="/admin/results" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
        → View Admin Results
      </a>
      <a href="/admin" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700">
        → Admin Dashboard
      </a>
    </div>
  </div>
</body>
</html>
