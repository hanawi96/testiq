---
import AdminLayout from '../../layouts/AdminLayout.astro';

// Test debug dashboard stats
let debugResults = {
  success: false,
  data: null,
  error: null,
  loadTime: 0
};

try {
  console.log('üîß DEBUG: Testing fixed dashboard stats...');
  const startTime = Date.now();
  
  const { debugDashboardStats } = await import('../../../backend/utils/dashboard-stats-service');
  const results = await debugDashboardStats();
  
  const loadTime = Date.now() - startTime;
  
  debugResults = {
    success: true,
    data: results,
    error: null,
    loadTime
  };
  
  console.log(`‚úÖ DEBUG: Fixed stats loaded in ${loadTime}ms`);
  
} catch (error) {
  console.error('‚ùå DEBUG: Error testing fixed stats:', error);
  debugResults = {
    success: false,
    data: null,
    error: error.message,
    loadTime: 0
  };
}
---

<AdminLayout title="Debug Fixed Stats">
  <div class="max-w-6xl mx-auto p-6">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">üîß DEBUG: Fixed Dashboard Stats</h1>
      <p class="text-gray-600">Ki·ªÉm tra fix l·ªói Top 5 qu·ªëc gia</p>
    </div>

    {debugResults.success ? (
      <div class="space-y-6">
        <!-- Status Overview -->
        <div class="bg-green-50 border border-green-200 rounded-xl p-6">
          <h2 class="text-xl font-semibold text-green-800 mb-4">‚úÖ Fix th√†nh c√¥ng!</h2>
          <div class="grid md:grid-cols-4 gap-4">
            <div class="bg-white p-4 rounded-lg">
              <div class="text-2xl font-bold text-blue-600">{debugResults.data.debug.rawRecords}</div>
              <div class="text-sm text-gray-600">Raw Records</div>
            </div>
            <div class="bg-white p-4 rounded-lg">
              <div class="text-2xl font-bold text-green-600">{debugResults.data.debug.validRecords}</div>
              <div class="text-sm text-gray-600">Valid Records</div>
            </div>
            <div class="bg-white p-4 rounded-lg">
              <div class="text-2xl font-bold text-orange-600">{debugResults.data.totalCountries}</div>
              <div class="text-sm text-gray-600">Countries</div>
            </div>
            <div class="bg-white p-4 rounded-lg">
              <div class="text-2xl font-bold text-purple-600">{debugResults.loadTime}ms</div>
              <div class="text-sm text-gray-600">Load Time</div>
            </div>
          </div>
        </div>

        <!-- Main Stats -->
        <div class="bg-white rounded-xl shadow-sm border p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">üìä Fixed Dashboard Stats</h2>
          <div class="grid md:grid-cols-4 gap-4">
            <div class="text-center">
              <div class="text-3xl font-bold text-blue-600">{debugResults.data.totalCountries}</div>
              <div class="text-sm text-gray-600">Qu·ªëc gia</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-green-600">{debugResults.data.totalParticipants}</div>
              <div class="text-sm text-gray-600">Ng∆∞·ªùi tham gia</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-purple-600">{debugResults.data.globalAverageIQ}</div>
              <div class="text-sm text-gray-600">IQ trung b√¨nh</div>
            </div>
            <div class="text-center">
              <div class="text-3xl font-bold text-orange-600">{debugResults.data.averageTestTime}</div>
              <div class="text-sm text-gray-600">Th·ªùi gian TB</div>
            </div>
          </div>
        </div>

        <!-- Top Countries by Participants -->
        <div class="bg-white rounded-xl shadow-sm border p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">üî• Top 5 qu·ªëc gia nhi·ªÅu ng∆∞·ªùi ch∆°i (FIXED)</h2>
          {debugResults.data.topCountriesByParticipants.length > 0 ? (
            <div class="space-y-3">
              {debugResults.data.topCountriesByParticipants.map((country, idx) => (
                <div key={idx} class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                  <div class="flex items-center gap-3">
                    <span class="text-2xl font-bold text-gray-400">#{idx + 1}</span>
                    <span class="text-2xl">{country.flag}</span>
                    <span class="font-semibold text-gray-800">{country.country}</span>
                  </div>
                  <span class="text-2xl font-bold text-green-600">{country.participants}</span>
                </div>
              ))}
            </div>
          ) : (
            <div class="text-center text-gray-500 py-4">Kh√¥ng c√≥ d·ªØ li·ªáu</div>
          )}
        </div>

        <!-- Top Countries by IQ -->
        <div class="bg-white rounded-xl shadow-sm border p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">üåü Top 5 qu·ªëc gia IQ cao nh·∫•t (FIXED)</h2>
          {debugResults.data.topCountriesByIQ.length > 0 ? (
            <div class="space-y-3">
              {debugResults.data.topCountriesByIQ.map((country, idx) => (
                <div key={idx} class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                  <div class="flex items-center gap-3">
                    <span class="text-2xl font-bold text-gray-400">#{idx + 1}</span>
                    <span class="text-2xl">{country.flag}</span>
                    <span class="font-semibold text-gray-800">{country.country}</span>
                  </div>
                  <span class="text-2xl font-bold text-blue-600">{country.avgIQ}</span>
                </div>
              ))}
            </div>
          ) : (
            <div class="text-center text-gray-500 py-4">Kh√¥ng c√≥ d·ªØ li·ªáu (√≠t h∆°n 5 tests)</div>
          )}
        </div>

        <!-- Debug Info -->
        <div class="bg-gray-50 rounded-xl p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">üîç Debug Information</h2>
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <h3 class="font-semibold text-gray-800 mb-2">Data Quality:</h3>
              <div class="space-y-2 text-sm">
                <div class="flex justify-between">
                  <span>Raw records:</span>
                  <span class="font-semibold">{debugResults.data.debug.rawRecords}</span>
                </div>
                <div class="flex justify-between">
                  <span>Valid records:</span>
                  <span class="font-semibold text-green-600">{debugResults.data.debug.validRecords}</span>
                </div>
                <div class="flex justify-between">
                  <span>Records with country:</span>
                  <span class="font-semibold text-blue-600">{debugResults.data.debug.recordsWithCountry}</span>
                </div>
                <div class="flex justify-between">
                  <span>Data quality:</span>
                  <span class="font-semibold text-purple-600">
                    {((debugResults.data.debug.validRecords / debugResults.data.debug.rawRecords) * 100).toFixed(1)}%
                  </span>
                </div>
              </div>
            </div>

            <div>
              <h3 class="font-semibold text-gray-800 mb-2">Country Codes (first 10):</h3>
              <div class="text-sm text-gray-600">
                {debugResults.data.debug.uniqueCountryCodes.slice(0, 10).join(', ')}
                {debugResults.data.debug.uniqueCountryCodes.length > 10 && '...'}
              </div>
              <div class="text-xs text-gray-500 mt-2">
                Total: {debugResults.data.debug.uniqueCountryCodes.length} countries
              </div>
            </div>
          </div>
        </div>

        <!-- Success Summary -->
        <div class="bg-green-100 border border-green-300 rounded-xl p-6">
          <h2 class="text-xl font-semibold text-green-800 mb-2">üéâ Fix Summary</h2>
          <ul class="text-green-700 space-y-1">
            <li>‚úÖ Lo·∫°i b·ªè ƒëi·ªÅu ki·ªán sai: <code>score > 0</code> ‚Üí ch·ªâ check <code>score != null && score >= 0</code></li>
            <li>‚úÖ ƒê∆°n gi·∫£n h√≥a logic country stats: b·ªè c√°c field kh√¥ng c·∫ßn thi·∫øt</li>
            <li>‚úÖ Fix calculation: s·ª≠ d·ª•ng validParticipants thay v√¨ totalRecords</li>
            <li>‚úÖ ƒê∆°n gi·∫£n h√≥a Top Countries: b·ªè thu·∫≠t to√°n ph·ª©c t·∫°p, d√πng logic ƒë∆°n gi·∫£n</li>
            <li>‚úÖ Minimum 5 tests thay v√¨ 25 (h·ª£p l√Ω h∆°n cho data nh·ªè)</li>
          </ul>
        </div>
      </div>
    ) : (
      <!-- Error State -->
      <div class="bg-red-50 border border-red-200 rounded-xl p-6">
        <h2 class="text-xl font-semibold text-red-800 mb-4">‚ùå Debug failed</h2>
        <div class="text-red-700">{debugResults.error}</div>
      </div>
    )}

    <!-- Navigation -->
    <div class="mt-8 flex gap-4">
      <a href="/admin" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
        ‚Üê Admin Dashboard
      </a>
      <a href="/admin/dashboard-test" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
        Dashboard Test
      </a>
      <a href="/leaderboard" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
        Xem Leaderboard Fixed ‚Üí
      </a>
    </div>
  </div>
</AdminLayout> 